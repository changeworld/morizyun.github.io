<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Rake | 酒と泪とRubyとRailsと]]></title>
  <link href="http://morizyun.github.io/blog/categories/rake/atom.xml" rel="self"/>
  <link href="http://morizyun.github.io/"/>
  <updated>2015-12-30T21:03:25+09:00</updated>
  <id>http://morizyun.github.io/</id>
  <author>
    <name><![CDATA[morizyun]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[RailsでオリジナルRakeタスク作成からRSpecテストまで]]></title>
    <link href="http://morizyun.github.io/blog/rake-task-rails-rspec-test/"/>
    <updated>2014-02-13T21:20:00+09:00</updated>
    <id>http://morizyun.github.io/blog/rake-task-rails-rspec-test</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/gp/product/4797372273/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4797372273&linkCode=as2&tag=morizyun00-22"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&ASIN=4797372273&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=morizyun00-22" width="150" style="float: left; margin: 0 20px 20px 0;" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=morizyun00-22&l=as2&o=9&a=4797372273" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />RailsのRakeタスク作成〜RSpecでのテストまでの流れをまとめました。
できるだけシンプルにまとめたので、Rakeタスクの作成に初めてトライされる方はぜひご一読下さい。</p>

<p><strong>02/13 22:10 全体的に説明書きを書き直し</strong><br/></p>

<!-- more -->


<br style="clear:both;"/>


<h2>Rake タスクファイルの作成</h2>

<p>次のコマンドを実行すると、Rakeタスク用のファイルが<code>lib/tasks</code>の下に作成されます。<br/>(<code>reports</code>の部分は任意の名前に変更してください)</p>

<p>{% codeblock lang:bash %}
rails g task reports
{% endcodeblock %}</p>

<p>上で生成された<code>lib/tasks/reports.rake</code>に処理を記述。</p>

<p>{% codeblock lang:ruby %}
namespace :reports do
  # descの記述は必須
  desc "Generate report"</p>

<p>  # :environment は モデルにアクセスするのに必須
  task :generate => :environment do</p>

<pre><code># 処理を記述
ReportGenerator.generate
</code></pre>

<p>  end
end
{% endcodeblock %}</p>

<p>ここまで完了するとrakeタスクの中に<code>reports:generate</code>が追加されます。</p>

<p>{% codeblock lang:bash %}
rake -vT</p>

<h1>rake reports:generate  # hoge の説明" # &lt;= となっていれば成功</h1>

<p>{% endcodeblock %}</p>

<p>次のコマンドで、作成した<code>reports:generate</code>のRakeタスクを実行することができます。</p>

<p>{% codeblock lang:bash %}
rake reports:generate
{% endcodeblock %}</p>

<h2>Rake タスクのRSpecを作成</h2>

<p>Rake タスクのテストですが、<strong><a href="https://twitter.com/netwillnet">@netwillnet</a></strong>さんのgem『<strong><a href="http://willnet.in/53">Rspec で rake タスクをテストする用の gem を作った</a></strong>』で詳解されているgem『<a href="https://github.com/willnet/rake_shared_context">rake_shared_context</a>』を使う方法を書いておきます。</p>

<p>この方法は、<strong><a href="http://robots.thoughtbot.com/test-rake-tasks-like-a-boss">thoughtbotさんのブログに書かれていたrakeのテスト方法</a></strong>をgem化したものだそうです。こちらも読んでおくと捗ります！</p>

<p>まずはGemfileに以下を追加して、ターミナルで<code>bundle install</code>を実行。</p>

<p>{% codeblock lang:ruby %}
gem 'rake'</p>

<h1>shared_context for rake tasks</h1>

<p>gem 'rake_shared_context'
{% endcodeblock %}</p>

<p><code>spec/lib/tasks/reports_rake_spec.rb</code>を作成して、テストを記述。</p>

<p>{% codeblock lang:ruby %}
require 'spec_helper'</p>

<p>describe 'reports:generate' do
  include_context 'rake'</p>

<p>  its(:prerequisites) { should include('environment') }</p>

<p>  it 'generates the report' do</p>

<pre><code>ReportGenerator.should_receive(:generate)
subject.invoke
</code></pre>

<p>  end
end
{% endcodeblock %}</p>

<p>かなり簡単にRakeタスクのテストができちゃいます！</p>

<h2>Special Thanks</h2>

<ul>
<li><p><a href="http://qiita.com/items/9a9b0703ac4c76ebfd4e">Rakeタスクをつくる | Qiita</a></p></li>
<li><p><a href="http://qiita.com/items/699749c631f66e62637b">Rake タスクをテストコードの中で複数回実行する | Qiita</a></p></li>
<li><p><a href="http://www.philsergi.com/2009/02/testing-rake-tasks-with-rspec.html">Testing Rake Tasks with RSpec</a></p></li>
</ul>


<h2>変更来歴</h2>

<p>12/12/05 22:00 gem 'rake'インストールを追加<br/>
12/12/11 12:55 taskのサンプルコード内にコメントを追記<br/>
12/12/17 10:45 コード内の注意書きを追記<br/>
13/12/31 16:20 Rails4 x Ruby 2.1環境で動作確認<br/>
14/02/13 21:20 全体的に説明書きを書き直し<br/></p>
]]></content>
  </entry>
  
</feed>
