<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Google Analytics | 酒と泪とRubyとRailsと]]></title>
  <link href="http://morizyun.github.io/blog/categories/google-analytics/atom.xml" rel="self"/>
  <link href="http://morizyun.github.io/"/>
  <updated>2015-07-05T18:40:53+09:00</updated>
  <id>http://morizyun.github.io/</id>
  <author>
    <name><![CDATA[morizyun]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[turbolinks対応 はてブボタン/Twitterボタン/Facebook いいねボタン/Google Analytics/Pocket/Google+ を綺麗に表示[Rails 4]]]></title>
    <link href="http://morizyun.github.io/blog/turbolinks-hatena-facebook-twitter-google-anatlycis/"/>
    <updated>2015-02-01T11:20:00+09:00</updated>
    <id>http://morizyun.github.io/blog/turbolinks-hatena-facebook-twitter-google-anatlycis</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/gp/product/4774158798/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4774158798&linkCode=as2&tag=morizyun00-22"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&ASIN=4774158798&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=morizyun00-22" width="150" style="float: left; margin: 0 20px 20px 0;" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=morizyun00-22&l=as2&o=9&a=4774158798" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
Rails4のturbolinksに対応させつつ、はてなブックマークやTwitter、Facebookいいねボタンなどのソーシャルボタンを縦でずらさずにキレイに並べる方法をまとめました。また、Google Analyticsの導入も一緒にしちゃいます！あと、PocketとGoogle+にも対応しました！</p>

<!-- more -->


<br style="clear:both;"/>


<p>{% include custom/google_ads_yoko_naga.html %}</p>

<h2>各種ボタンの設置 - slim</h2>

<p>以下の様にボタンの表示を設定します。<code>canonical_url</code>はシェアしたいURL、<code>page_title</code>は
そのページのタイトルです。</p>

<p>{% codeblock lang:slim %}
.social.clearfix
  /! Facebook
  .button.facebook</p>

<pre><code>#fb-root
.fb-like data-href=("#{canonical_url}") data-layout="button_count" data-send="false" data-show-faces="false" data-width="120"
</code></pre>

<p>  /! Twitter
  .button.twitter</p>

<pre><code>a.twitter-share-button data-lang="en" data-text=("#{page_title(controller_name, action_name)}") data-url=("#{canonical_url}") href="https://twitter.com/share"  Tweet
</code></pre>

<p>  /! Pocket
  .button.pocket</p>

<pre><code>a.pocket-btn data-lang="en" data-pocket-align="left" data-pocket-count="horizontal" data-save-url=("#{canonical_url}") href="https://getpocket.com/save"  Pocket
</code></pre>

<p>  /! Hatena
  .button.hatena</p>

<pre><code>a.hatena-bookmark-button data-hatena-bookmark-lang="ja" data-hatena-bookmark-layout="standard" href=("http://b.hatena.ne.jp/entry/#{canonical_url}") title="このエントリーをはてなブックマークに追加"
  img alt="このエントリーをはてなブックマークに追加" height="20" src="http://b.st-hatena.com/images/entry-button/button-only.gif" style=('border: none') width="20" /
</code></pre>

<p>  /! Google plusone
  .button.google</p>

<pre><code>.g-plusone data-href=("#{canonical_url}") data-size="medium"
</code></pre>

<p>{% endcodeblock %}</p>

<p>ボタンの種類等は、公式サイトをみて調整して下さい。</p>

<p><a href="http://b.hatena.ne.jp/guide/bbutton">はてなブックマークボタンの作成・設置について</a></p>

<p><a href="https://twitter.com/about/resources/buttons">Twitter / Twitterボタン</a></p>

<p><a href="http://developers.facebook.com/docs/reference/plugins/like/">Like Button - Facebook開発者</a></p>

<h2>headダグへのjavascriptの追加</h2>

<p>Google Analytics、TwitterボタンのJavascriptの読み込みを<code>headタグ</code>内に書き込みます。
ここでは本番環境でのみ、Google Analyticsを読み込むように設定しています。</p>

<p>{% codeblock lang:slim %}
erb: # hamlの場合は :erb
  <script></p>

<pre><code>(function(w,d){
  var s,e = d.getElementsByTagName("script")[0],
  a=function(u,f){if(!d.getElementById(f)){s=d.createElement("script");
  s.async=!0;s.src=u;if(f){s.id=f;}e.parentNode.insertBefore(s,e);}};
  a("https://apis.google.com/js/plusone.js");
  a("//b.st-hatena.com/js/bookmark_button_wo_al.js");
  a("//platform.twitter.com/widgets.js","twitter-wjs");
  a("https://widgets.getpocket.com/v1/j/btn.js?v=1");
})(this, document);

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-XXXXXXXX-Y', 'YOUR_DOMAIN');
ga('send', 'pageview');
</code></pre>

<p>  </script>
{% endcodeblock %}</p>

<p><code>UA-XXXXXXXX-Y</code>は、<strong><a href="http://www.google.co.jp/intl/ja/analytics/">Google Analytics</a></strong>でサイトを登録するともらえる『<strong>トラッキングID</strong>』をセットして下さい。</p>

<h2>turbolinks対応でボタンのjsを読み込むようにjs追加</h2>

<p>さらにFacebook/Twitter/はてぶのjavascriptファイルをturbolinksでもよしなに読み込んでくれるようにjsを追加します。
ここでは、coffeescriptを使ってコードをかきます！</p>

<p>{% codeblock lang:coffeescript %}
ready = ->
  # Hatena
  loadHatenaSDK()</p>

<p>  # Facebook
  loadFacebookSDK()
  bindFacebookEvents() unless fb_events_bound</p>

<p>  # Twitter
  loadTwitterSDK()
  bindTwitterEventHandlers() unless twttr_events_bound</p>

<h1>For turbolinks</h1>

<p>$(document).ready(ready)
$(document).on('page:load', ready)</p>

<h1>-----------------------------------------</h1>

<h1>Facebook</h1>

<h1>-----------------------------------------</h1>

<p>fb_root = null
fb_events_bound = false</p>

<p>bindFacebookEvents = ->
  $(document)
  .on('page:fetch', saveFacebookRoot)
  .on('page:change', restoreFacebookRoot)
  .on('page:load', -></p>

<pre><code>FB?.XFBML.parse()
</code></pre>

<p>  )
  fb_events_bound = true</p>

<p>saveFacebookRoot = ->
  fb_root = $('#fb-root').detach()</p>

<p>restoreFacebookRoot = ->
  if $('#fb-root').length > 0</p>

<pre><code>$('#fb-root').replaceWith fb_root
</code></pre>

<p>  else</p>

<pre><code>$('body').append fb_root
</code></pre>

<p>loadFacebookSDK = ->
  window.fbAsyncInit = initializeFacebookSDK
  $.getScript("//connect.facebook.net/ja_JP/all.js#xfbml=1")</p>

<p>initializeFacebookSDK = ->
  FB.init</p>

<pre><code>appId     : YOUR_APP_ID
channelUrl: '//WWW.YOUR_DOMAIN.COM/channel.html'
status    : true
cookie    : true
xfbml     : true
</code></pre>

<h1>-----------------------------------------</h1>

<h1>Twitter</h1>

<h1>-----------------------------------------</h1>

<p>twttr_events_bound = false</p>

<p>bindTwitterEventHandlers = ->
  $(document).on 'page:load', renderTweetButtons
  twttr_events_bound = true</p>

<p>renderTweetButtons = ->
  $('.twitter-share-button').each -></p>

<pre><code>button = $(this)
button.attr('data-url', document.location.href) unless button.data('url')?
button.attr('data-text', document.title) unless button.data('text')?
</code></pre>

<p>  twttr.widgets.load()</p>

<p>loadTwitterSDK = ->
  $.getScript("//platform.twitter.com/widgets.js")</p>

<h1>-----------------------------------------</h1>

<h1>Hatena</h1>

<h1>-----------------------------------------</h1>

<p>loadHatenaSDK = ->
  $.getScript("//b.st-hatena.com/js/bookmark_button_wo_al.js")</p>

<h1>-----------------------------------------</h1>

<h1>Google Analytics</h1>

<h1>-----------------------------------------</h1>

<p>$(document).on 'page:load page:restore', ->
  if window.ga?</p>

<pre><code>ga('set', 'location', location.href.split('#')[0])
ga('send', 'pageview')
</code></pre>

<h1>-----------------------------------------</h1>

<h1>Google+</h1>

<h1>-----------------------------------------</h1>

<p>loadGoogleSDK = ->
  $.getScript("https://apis.google.com/js/plusone.js")</p>

<h1>-----------------------------------------</h1>

<h1>Hatena</h1>

<h1>-----------------------------------------</h1>

<p>loadHatenaSDK = ->
  $.getScript("//b.st-hatena.com/js/bookmark_button_wo_al.js")</p>

<h1>-----------------------------------------</h1>

<h1>Pocket</h1>

<h1>-----------------------------------------</h1>

<p>loadPocketSDK = ->
  $.getScript("https://widgets.getpocket.com/v1/j/btn.js?v=1")</p>

<h1>-----------------------------------------</h1>

<h1>Google Analytics</h1>

<h1>-----------------------------------------</h1>

<p>class @GoogleAnalytics</p>

<p>  @load: -></p>

<pre><code># Google Analytics depends on a global _gaq array. window is the global scope.
window._gaq = []
window._gaq.push ["_setAccount", GoogleAnalytics.analyticsId()]

# Create a script element and insert it in the DOM
ga = document.createElement("script")
ga.type = "text/javascript"
ga.async = true
ga.src = ((if "https:" is document.location.protocol then "https://ssl" else "http://www")) + ".google-analytics.com/ga.js"
firstScript = document.getElementsByTagName("script")[0]
firstScript.parentNode.insertBefore ga, firstScript

# If Turbolinks is supported, set up a callback to track pageviews on page:change.
# If it isn't supported, just track the pageview now.
if typeof Turbolinks isnt 'undefined' and Turbolinks.supported
  document.addEventListener "page:change", (-&gt;
    GoogleAnalytics.trackPageview()
  ), true
else
  GoogleAnalytics.trackPageview()
</code></pre>

<p>  @trackPageview: (url) -></p>

<pre><code>unless GoogleAnalytics.isLocalRequest()
  if url
    window._gaq.push ["_trackPageview", url]
  else
    window._gaq.push ["_trackPageview"]
  window._gaq.push ["_trackPageLoadTime"]
</code></pre>

<p>  @isLocalRequest: -></p>

<pre><code>GoogleAnalytics.documentDomainIncludes "local"
</code></pre>

<p>  @documentDomainIncludes: (str) -></p>

<pre><code>document.domain.indexOf(str) isnt -1
</code></pre>

<p>  @analyticsId: -></p>

<pre><code># your google analytics ID(s) here...
</code></pre>

<p>GoogleAnalytics.load()
{% endcodeblock %}</p>

<p><code>YOUR_APP_ID</code>は<strong><a href="https://developers.facebook.com/">Facebook開発者</a></strong>でWebアップを登録するともらえるアプリIDをセットして下さい。</p>

<p><code>//WWW.YOUR_DOMAIN.COM/channel.html</code>には、良いねを押して欲しいURLのプロトコル以下をセットします。</p>

<p>『<strong><a href="http://www.workabroad.jp/posts/2083">Rails / Turbolinksに対応したソーシャルボタンを配置する（Facebook, Twitter, Google+, Pocket, はてブ） | Workabroad.jp</a></strong>』さんの記事にめちゃくちゃ助けてもらいました！有難うございます＾＾</p>

<h2>CSS修正</h2>

<p>SCSSに以下の内容を追加しました。</p>

<p>{% codeblock lang:css %}
.social {
  line-height: 0.8;
  margin-top: 10px;
  font-size: 12px;
  font-weight: normal;</p>

<p>  .button {</p>

<pre><code>float: left;
overflow: hidden;
margin-right: 5px;
margin-bottom: 4px;

&amp;.facebook {
  margin-right: 17px;
}

&amp;.twitter {
  width: 90px;
}

&amp;.pocket {
  width: 100px;
}

&amp;.google {
  width: 60px;
  margin-right: 0;
}

&amp;.hatena {
  margin-right: 17px;
}
</code></pre>

<p>  }
}
{% endcodeblock %}</p>

<h2>ブラウザで確認</h2>

<p>MacのSafari/Firefox/Chromeで確認しました。</p>

<p><img src="https://farm8.staticflickr.com/7436/15786748194_faa52826b5_o.png" width="924" height="82" alt="スクリーンショット 2015-01-31 21.00.18"></p>

<p>Windowsは所有していないので試せていません。
もし不具合があるようだったらぜひ教えて下さい！</p>

<p>{% include custom/google_ads_yoko_naga.html %}</p>

<h2>Special Thanks</h2>

<p><a href="http://reed.github.io/turbolinks-compatibility/google_analytics.html">Turbolinks Compatibility with Google Analytics</a></p>

<p><a href="http://www.workabroad.jp/posts/2083">Rails / Turbolinksに対応したソーシャルボタンを配置する（Facebook, Twitter, Google+, Pocket, はてブ） | Workabroad.jp</a></p>

<p><a href="http://www.waldiz.com/article.php/20120218003102941">複数のソーシャルボタンをきれいに整列表示させる簡単な方法</a></p>

<p><a href="http://tokkono.cute.coocan.jp/blog/slow/index.php/xhtmlcss/asynchronous-loading-of-major-social-buttons/">最近海外で流行りのTwitter,Facebook,Google+1,Analyticsをまとめる非同期スクリプトにはてなを加えてみた</a></p>

<p><a href="http://mainsblog.blog111.fc2.com/blog-entry-263.html">ソーシャルボタンをキレイに並べる</a></p>

<p><a href="http://qiita.com/shimoju/items/f53ccb73e7a500396279">JavaScript - Google AnalyticsをRails 4のTurbolinksに対応させる - Qiita キータ</a></p>

<p><a href="http://reed.github.io/turbolinks-compatibility/facebook.html">Turbolinks Compatibility with Facebook</a></p>

<p><a href="http://reed.github.io/turbolinks-compatibility/twitter.html">Turbolinks Compatibility with Twitter</a></p>

<p><a href="http://d.hatena.ne.jp/deeeki/20121202/rails4_turbolinks">Rails4 Turbolinksのメモ #mtsmhack - 130単位</a></p>
]]></content>
  </entry>
  
</feed>
