<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | 酒と泪とRubyとRailsと]]></title>
  <link href="http://morizyun.github.io/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://morizyun.github.io/"/>
  <updated>2015-12-30T21:10:52+09:00</updated>
  <id>http://morizyun.github.io/</id>
  <author>
    <name><![CDATA[morizyun]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[「ぼくのかんがえたさいきょうの Rails スタートダッシュ」というタイトルで発表してきました！]]></title>
    <link href="http://morizyun.github.io/blog/rails-learning-start-dash-slide/"/>
    <updated>2015-12-30T21:00:00+09:00</updated>
    <id>http://morizyun.github.io/blog/rails-learning-start-dash-slide</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/gp/product/4774178020/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4774178020&linkCode=as2&tag=morizyun00-22"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&ASIN=4774178020&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=morizyun00-22" width="150" style="float: left; margin: 0 20px 20px 0;" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=morizyun00-22&l=as2&o=9&a=4774178020" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
2015/12/22に社内勉強会で「ぼくのかんがえたさいきょうの Rails スタートダッシュ」というタイトルで発表をしてきました！</p>

<!-- more -->


<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>

<h2>発表スライド</h2>

<p>まずは発表スライドはこちら！</p>

<iframe src="http://morizyun.github.io//www.slideshare.net/slideshow/embed_code/key/h23sQZZPbyzwK6" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<h2>特に伝えたかったこと</h2>

<ul>
<li>Web開発は、git/javascript/css/ruby/CI等々覚えることたくさんで大変</li>
<li>新しい技術もどんどん生まれていくので、学び続けることが大切</li>
<li>学び続けるためには、「楽しむこと」。楽しめるものを見つけよう</li>
<li>Railsは日本語ドキュメント充実してるから、Web 開発を始めたいなという人におすすめ</li>
</ul>


<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[「個人開発のススメ」というタイトルで発表してきました！]]></title>
    <link href="http://morizyun.github.io/blog/individual-development-slide-gunosy-beer-bash/"/>
    <updated>2015-12-28T20:05:00+09:00</updated>
    <id>http://morizyun.github.io/blog/individual-development-slide-gunosy-beer-bash</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/gp/product/4883379930/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4883379930&linkCode=as2&tag=morizyun00-22"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&ASIN=4883379930&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=morizyun00-22" width="150" style="float: left; margin: 0 20px 20px 0;" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=morizyun00-22&l=as2&o=9&a=4883379930" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
2015/12/05に『<strong><a href="http://gunosy-beer.connpass.com/event/22825/">エムスリー x Gunosy Beer bash！</a></strong>』で、
「<strong><a href="http://www.slideshare.net/morizyun/ss-55929702">個人開発のススメ</a></strong>」というタイトルで発表しました！</p>

<!-- more -->


<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>

<h2>発表スライド</h2>

<p>まずは発表スライドはこちら！</p>

<iframe src="http://morizyun.github.io//www.slideshare.net/slideshow/embed_code/key/dZM4S2V9aL3js" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<h2>特に伝えたかったこと</h2>

<ul>
<li>今回伝えたいこと 個人開発は「夢」がある！ (๑•̀ㅁ•́๑)✧</li>
<li>企業はスケールして利益の出るものしか作れない</li>
<li>個人エンジニアなら自分で作れるので思う存分、自分の満足を追求できるよ！</li>
<li>アイデアは質より量。思いつきをメモにまとめて、簡単なものから作ってみよう！</li>
<li>もくもく会に出て、仲間を見つけたり、ブログやQiitaで記事を書こう</li>
</ul>


<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[【Rails初学者向け】Twitterへ投稿するRailsアプリを作ってみよう]]></title>
    <link href="http://morizyun.github.io/blog/ruby-rails-beginner-twitter-post-app/"/>
    <updated>2015-12-26T19:50:00+09:00</updated>
    <id>http://morizyun.github.io/blog/ruby-rails-beginner-twitter-post-app</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/gp/product/4797380357/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4797380357&linkCode=as2&tag=morizyun00-22"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&ASIN=4797380357&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=morizyun00-22" width="150" style="float: left; margin: 0 20px 20px 0;" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=morizyun00-22&l=as2&o=9&a=4797380357" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
最近初心者の人向けにRuby/Railsのアプリの開発についてレクチャーしたので、その時作った手順をブログ記事にしました。</p>

<p>もし、やってみてわからないところとか、ハマりやすいところとかあれば <strong><a href="https://twitter.com/zyunnosuke">@zyunnosuke</a></strong> にメッセージください！</p>

<!-- more -->


<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>

<h2>プロジェクトを作成</h2>

<h3>ローカル開発の場合</h3>

<p>ターミナルで以下のコマンドを実行してください。</p>

<p>```</p>

<h1>新しいRailsアプリを作成</h1>

<p>rails new twitter_post_sample --skip-bundle</p>

<h1>twitter_post_sample のフォルダに移動</h1>

<p>cd twitter_post_sample
```</p>

<h3>Cloud 9の場合</h3>

<ul>
<li>『<strong><a href="https://c9.io/">Cloud9</a></strong>』にログインして新しいworkspaceを作成</li>
<li>privateのRailsアプリを作成してください</li>
</ul>


<h2>Gemfileに以下を追加</h2>

<p>プロジェクト直下のGemfileを開いて以下を追加して下さい。
(minimum-omniauth-scaffold は最後に補足を書いています)</p>

<p><code>ruby
gem 'twitter'
gem 'minimum-omniauth-scaffold'
gem 'haml'
</code></p>

<p>追加したらターミナルで以下のコマンドを実行します。</p>

<p><code>
bundle install --jobs=4 --path=vendor/bundle
</code></p>

<p>Ruby Gemライブラリをインターネットから持ってきて、自動でローカルに保存します。</p>

<h2>Twitter認証用のScaffold</h2>

<p>以下のコマンドを実行して、OmniAuth用のScaffoldを作成。</p>

<p><code>
bundle exec rails g minimum:omniauth:scaffold
</code></p>

<h2>テーブルの作成</h2>

<p><code>
bundle exec rake db:migrate
</code></p>

<h2>TwitterのAPI keyを取得</h2>

<p><a href="https://apps.twitter.com/">Twitter Application Management</a>に新しいアプリを登録して下さい。
手順がわからない場合は、『<a href="http://blogs.zealot.co.jp/archives/810">Rails環境でTwitterとFacebookを使ってサイトの拡散をするため自動投稿させるアプリを作成してみた</a>』
を参考にしてみてください。</p>

<p>最初にユーザー登録とか必要かもしれません。</p>

<p>ちなみに設定は以下の様ようにしました。</p>

<pre>
Name : (ユニークな名前にしてください。クライアント名としてtwitter上で表示されるのでいい名前にしてください)
Description : (適当に書いてください)
Website : http://www.example.com (公開するときはそのURLを。今回はローカルテスト用の設定です)
Callback URL : http://www.example.com/callback (公開するときはコールバックのURLを書いてください。今回はローカルテスト用の設定です)
</pre>


<p>「Keys and Access Tokens」に Consumer Key と Consumer Secret があるので、次のファイルに書いてください。</p>

<h2>Twitter API keyをRailsに設定</h2>

<p><code>config/settings.local.yml</code> を開いて以下の内容を追記して下さい。</p>

<p>```ruby</p>

<h1>Twitter OAuth Local Setting</h1>

<h1>- 可能なら環境変数にしてしまったほうがいいと思います</h1>

<p>twitter_key:    "xxxxxxxxxxxxxxxxxxxxxxx"
twitter_secret: "yyyyyyyyyyyyyyyyyyyyyyyyyyyy"
```</p>

<h2>controllerの処理を追加</h2>

<p>新しい処理を行うcontrollerのactionを追加します。</p>

<p><code>app/controller/top_controller.rb</code>に以下の内容を追加します。</p>

<p>```ruby
class TopController &lt; ApplicationController
  # ↓ ここを追加
  # tweet
  def tweet</p>

<pre><code>client = Twitter::REST::Client.new do |config|
  # applicationの設定
  config.consumer_key         = Settings.twitter_key
  config.consumer_secret      = Settings.twitter_secret
  # ユーザー情報の設定
  user_auth = current_user.authentications.first
  config.access_token         = user_auth.token
  config.access_token_secret  = user_auth.secret
end

# Twitter投稿
client.update(params[:text])

redirect_to root_path, notice: 'ツイートしました！'
</code></pre>

<p>  end
end
```</p>

<h2>viewを作成</h2>

<p><code>app/views/top/index.html.haml</code> にフォームを設置します。</p>

<p><code>
= form_tag tweet_path do
  = text_area_tag :text
  = submit_tag 'ツイートする'
</code></p>

<p>あと念のため、今回は facebook / githubのログインは削除します。</p>

<p><code>app/views/layouts/application.html.haml</code> の以下を削除してください。</p>

<p><code>
= link_to 'Facebook', '/auth/facebook'
= link_to 'GitHub',   '/auth/github'
</code></p>

<h2>routesに以下を追加</h2>

<p>ルーティング情報を追加します。</p>

<p><code>config/routes.rb</code>に以下の内容を追加します。</p>

<p><code>ruby
Rails.application.routes.draw do
  # tweet
  post '/top/tweet' =&gt; 'top#tweet', as: :tweet
end
</code></p>

<h2>実行確認</h2>

<p>ターミナルで以下のコマンドを実行して rails サーバーを起動してください。
(Cloud9の場合は、startボタンでrailsサーバーを起動)</p>

<p><code>
bundle exec rails s
</code></p>

<p>そして、ブラウザで <code>http://localhost:3000</code> を開いてください。</p>

<p><img src="https://farm6.staticflickr.com/5704/23980458535_2e8e6a5495.jpg" width="500" height="173"></p>

<p>左上の「<strong>Login: Twitter</strong>」をクリックしてログイン。そしてツイートボタンをおすと</p>

<p><img src="https://farm6.staticflickr.com/5669/23980479635_befe85ce67.jpg" width="500" height="162"></p>

<p>とツイートできました。(※ 実話です！)</p>

<h2>(補足) minimum-omniauth-scaffold について</h2>

<p>今回使ったRubyGemの <strong><a href="https://github.com/shu0115/minimum-omniauth-scaffold">shu0115/minimum-omniauth-scaffold</a></strong>
は、Facebook/Twitter/GitHubのアカウントを使ったログイン機能のscaffoldを提供してくれるGemです。</p>

<p>すごく便利なのでFacebook/Twitter/GitHubのアカウントを使ったログイン機能を実装したいときは、是非試してみてください。</p>

<p>ちなみに、拙著の紹介記事は、『<strong><a href="/blog/minimum-omniauth-scaffold/">「minimum-omniauth-scaffold」 Facebook/Twitter/GitHubログインを高速実装！</a></strong>』もおすすめです！</p>

<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>

<h2>Special Thanks</h2>

<ul>
<li><strong><a href="http://blogs.zealot.co.jp/archives/810">Rails環境でTwitterとFacebookを使ってサイトの拡散をするため自動投稿させるアプリを作成してみた</a></strong></li>
<li><strong><a href="http://d.hatena.ne.jp/Nunocky/20110127/p1">Railsアプリから twitterにつぶやいてみた - Nunockyの日記</a></strong></li>
<li><strong><a href="http://qiita.com/ykyk1218/items/2541a313aac0f0e5d81a">Ruby - Railsのフォーム基本的な作成方法まとめ（form_forとかform_tag）</a></strong></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyKaigi 2015のMatzのキーノート・メモ]]></title>
    <link href="http://morizyun.github.io/blog/rubykaigi2015-matz-keynote/"/>
    <updated>2015-12-23T17:20:00+09:00</updated>
    <id>http://morizyun.github.io/blog/rubykaigi2015-matz-keynote</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/gp/product/4873113946/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4873113946&linkCode=as2&tag=morizyun00-22"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&ASIN=4873113946&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=morizyun00-22" width="150" style="float: left; margin: 0 20px 20px 0;" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=morizyun00-22&l=as2&o=9&a=4873113946" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />2015/12/11-13に開催された『<strong><a href="http://rubykaigi.org/2015">RubyKaigi 2015</a></strong>』に出席してきたので、その時のメモです。</p>

<p>とは言っても1日目から風邪でセッション中殆ど寝てて、２・３日目には熱がでて会場にすら行けなかったという
体たらくぶりでした。来年はマスクとか、うがい・手洗いとか万難を排して臨みたいと思っています...orz...</p>

<p>今回はまともに聞けてたMatzのKeynoteを中心にメモを書いていきます。</p>

<p>あとこの記事は、<strong><a href="http://qiita.com/advent-calendar/2015/m3">エムスリー Advent Calendar 2015 - Qiita</a></strong>の23日目です。</p>

<!-- more -->


<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>

<h2>プログラマーの三大美徳</h2>

<p>Perlの作者 Lally Wallの言葉。考えれば考える程いい言葉。</p>

<pre>
- 怠惰: プログラムを書いて、苦労を減らしたり、ドキュメントを書いて不要な質問を避ける
- 短気: 将来起こる問題を想定した設計、ロジックの無駄を排除した実装を行う
- 傲慢: 周りから文句が出ないような、自分が自信を持てるプログラムを書こう
</pre>


<h2>怒りに通じている</h2>

<p>「<strong>怒り</strong>」とは、制御されている限り有益なモチベーションの源泉となる。
ただし、怒りは他の人にネガティブな気持ちを伝染させてしまうので注意しよう。</p>

<h2>ナイスも人に移る</h2>

<ul>
<li>「<strong>ナイスさ</strong>」こそはRubyコミュニティの良さ => MINASWAN(Matz is Nice And So We Are Nice)</li>
<li>内心で怒っていても、外っつらは愛想よく、ナイスであろう</li>
</ul>


<h2>Ruby 2.3.0</h2>

<p>preview2が出た。クリスマスに合わせてリリース予定。新機能は次のようなもの。</p>

<pre>
- Did-you-mean
  - Gooogleのもしかして機能
- Enuerable#grep_v(inverseのv)
  - マッチしていないものを返す
- Hash#fetch_value
- Numeric$positive?, negative?
- Hwash comparisons(<=, <, >=, >) - No Comparable(<=>はない)
- Hash#to_proc
- Array,Hash,Struct$dig
- Indented here document(インデントの一番浅いところでとってくれる)
- froze-string-literal: true
- safe navigation operation => &.
  - u&.name&.first
</pre>


<p>Rubyの改善は、コミュニティの成果であう。</p>

<h2>OCaaS</h2>

<ul>
<li>OCaaS(OSS community as a Shark)、つまりオープンソースコミュニティは、動き続けなければ死ぬ。</li>
<li>変化を生み出し続ける必要があるが、変化を受け入れるのは、決して簡単なことではない。</li>
</ul>


<h2>変化</h2>

<ul>
<li>ユーザーのwantsを聞くべきではない。大切なのは隠れたneedsを見つけることだ</li>
<li>未来のことはわからないが「<strong>未来の変化</strong>」を生み出さないといけない</li>
</ul>


<h2>環境の変化</h2>

<p>Rubyの置かれている環境の変化として次の3つがある。</p>

<pre>
- Multi Core
- Code Scalability
- Data Scalability
</pre>


<h3>マルチコア</h3>

<pre>
- コンカレンシー
- 抽象度の高さがRubyの売り
- 候補
  - Ownership Model => 排他制御
  - STM => 現実的ではに
  - Streem model
</pre>


<p>この辺りで時間なくなったはず。。
Ruby3を2020年までにだして、Ruby 2.0より3倍早くするのが目標とのこと。
すごい！</p>

<h2>RubyKaigi で参考になりそうなサイト</h2>

<ul>
<li><strong><a href="https://www.youtube.com/channel/UCBSg5zH-VFJ42BGQFk4VH2A">RubyKaigi - YouTube</a></strong></li>
<li><strong><a href="http://togetter.com/li/911396">Ruby準国際カンファレンス #rubykaigi 2015 - Togetterまとめ</a></strong></li>
</ul>


<h2>RubyKaigiで個人的に面白かった発表</h2>

<p>テンプレートエンジンの高速化、FamlとHamlitの話はすごい面白かったです！</p>

<script async class="speakerdeck-embed" data-id="acd0c621607045aa8218049ae613747a" data-ratio="1.33333333333333" src="http://morizyun.github.io//speakerdeck.com/assets/embed.js"></script>




<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RailsエンジニアのためのSQLチューニング速習会@wantedlyに行ってきた！]]></title>
    <link href="http://morizyun.github.io/blog/sql-speedup-explain-rails/"/>
    <updated>2015-12-13T10:00:00+09:00</updated>
    <id>http://morizyun.github.io/blog/sql-speedup-explain-rails</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/gp/product/B00P0UR1RU/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=B00P0UR1RU&linkCode=as2&tag=morizyun00-22"><img border="0" src="http://ws.assoc-amazon.jp/widgets/q?_encoding=UTF8&ASIN=B00P0UR1RU&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=morizyun00-22" width="150" style="float: left; margin: 0 20px 20px 0;" ></a><img src="http://www.assoc-amazon.jp/e/ir?t=morizyun00-22&l=as2&o=9&a=B00P0UR1RU" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />『<strong><a href="http://wantedly.connpass.com/event/23794/">RailsエンジニアのためのSQLチューニング速習会 - connpass</a></strong>』に参加してきました。すごく勉強になったので、
その時のメモです。<strong><a href="https://twitter.com/minami7o">@minami7o</a></strong> さんありがとうございました！</p>

<p>あとこの記事は、<strong><a href="http://qiita.com/advent-calendar/2015/m3">エムスリー Advent Calendar 2015 - Qiita</a></strong>の13日目です。</p>

<!-- more -->


<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>

<h2>スライド</h2>

<p>Wantedlyの <strong><a href="https://twitter.com/minami7o">@minami7o</a></strong> さんの発表スライドです。</p>

<iframe src="http://morizyun.github.io//www.slideshare.net/slideshow/embed_code/key/hzRuN7dqFFk2nj" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen></iframe>


<h2>説明用のブランチ</h2>

<p>勉強会で共有されたテストデータを使えるGitHubのブランチです。</p>

<p><strong><a href="https://github.com/south37/sql-tuning">south37/sql-tuning - GitHub</a></strong></p>

<p><code>ruby
git clone git@github.com:south37/sql-tuning.git
cd sql-tuning
bin/rake db:create
pg_restore -j 4 --verbose --no-acl --no-owner -d sql-tuning-dev db.dump
</code></p>

<h2>ActiveRecord::Base.explain</h2>

<p>ActiveRecord::Baseに<code>#explain</code>があることを知らなかったです。<code>#explain</code>超便利！</p>

<p>```
[1] pry(main)> Job.joins(:company).group('companies.country').where('companies.id &lt; 1000').select('companies.country', 'COUNT(jobs.id)').explain
  Job Load (10.3ms)  SELECT companies.country, COUNT(jobs.id) FROM "jobs" INNER JOIN "companies" ON "companies"."id" = "jobs"."company_id" WHERE (companies.id &lt; 1000) GROUP BY companies.country
=> EXPLAIN for: SELECT companies.country, COUNT(jobs.id) FROM "jobs" INNER JOIN "companies" ON "companies"."id" = "jobs"."company_id" WHERE (companies.id &lt; 1000) GROUP BY companies.country</p>

<pre><code>                                          QUERY PLAN
</code></pre>

<hr />

<p> HashAggregate  (cost=1184.79..1191.12 rows=634 width=16)
   Group Key: companies.country
   ->  Hash Join  (cost=54.28..1159.79 rows=5000 width=16)</p>

<pre><code>     Hash Cond: (jobs.company_id = companies.id)
     -&gt;  Seq Scan on jobs  (cost=0.00..868.00 rows=50000 width=8)
     -&gt;  Hash  (cost=41.78..41.78 rows=1000 width=16)
           -&gt;  Index Scan using companies_pkey on companies  (cost=0.29..41.78 rows=1000 width=16)
                 Index Cond: (id &lt; 1000)
</code></pre>

<p>(8 rows)
```</p>

<p>ちなみにEXPLAINとは、与えられた文に対して、PostgreSQLプランナが生成する実行計画を表示するための命令です。</p>

<p>実行計画とは、問い合わせ文が参照するテーブル（複数の場合もある）をスキャンする方法（単純なシーケンススキャン、インデックススキャンなど）複数のテーブルを参照する場合に、各テーブルから取り出した行を結合するために使用されます。</p>

<h2>実行計画のコストの見方</h2>

<p>Explainでのコストの見方はこちら。</p>

<iframe src="http://morizyun.github.io//www.slideshare.net/slideshow/embed_code/key/hzRuN7dqFFk2nj?startSlide=11" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen></iframe>


<h2>indexの仕組み</h2>

<p>「B-tree index」とは、バランスド・ツリーインデックスの略です。
ソートアルゴリズムや二分木の進化版的なアルゴリズムだそうです。
一部のブランチが成長しすぎて、計算量が増えないように再編成(バランシング)する仕組みをもっています。
これにより、常に高い検索性能を保つことができるそうです。</p>

<h2>indexが効かないパターン</h2>

<pre>
- indexを貼ったカラムに演算(`lower`と演算子を使う場合、ただし後述の方法なら貼れる)
- 絞り込み条件のゆるいwhere (デフォルトだと4/1以下に絞り込まれる必要がある)
  - HDDへのランダムアクセスとシーケンシャルアクセスの速度差が原因
</pre>


<h2>index利用のデメリット</h2>

<pre>
- indexの更新に時間がかかる
- PostgreSQLのカラム更新を高速化するための仕組みの「HOT」が効かない
</pre>


<p>ちなみに「HOT(Heap Only Tuple)」とは、「インデックスを持たない、ヒープのみのタプル」だそうです。
(1)不要なインデックスの更新を行なわないことによる更新処理コストの削減や、(2)ガベージの自動回収
といったことをサポートしてくれます。</p>

<h2>インデックスの種類</h2>

<pre>
- Unique Indexes : 重複した値を許可しないようなインデックス
- Multicolumn Indexes : 2つ以上のカラムに対するインデックス
- Indexes on Expressions
  - 関数などの返り値を key として index を作る事ができる
</pre>


<h2>JOIN のアルゴリズム</h2>

<pre>
- Nested Loop Join (遅い)
  - テーブル1とテーブル2に対してすべての組み合わせを試す
  - テーブル2にindexがあれば早くなる
- Hash Join
  - テーブル2に対して、1度フルスキャンしてHashMapを作る
  - テーブル2の全レコードをメモリにのせる必要がある
- Merge Join (早い)
  - ソート済のテーブル1とテーブル2に対して一度だけフルスキャン
  - JOINに使うカラムにはindexを貼る
</pre>


<h2>データ集約</h2>

<pre>
- Group Aggregate
  - 入力されたデータをグループキーでソート後、各グループを順に処理
- Hash Aggregate
  - グループキーをkeyとする、一時的なHash Tableを作成する
</pre>


<h2>sortもindexをはるべき</h2>

<ul>
<li>予めindexを貼っておくとソートされた状態でデータが保持されている</li>
<li><code>ORDER BY</code>でsortを実施するときにはindexされたカラムを使おう</li>
</ul>


<h2>その他 PostgreSQLの特徴的機能</h2>

<pre>
- JSON型
  - json型とjsonb型がある
  - jsonb型を基本で使うべきだが、すごいきたないデータの場合json型になる
- Hstore型
  - key, valueのペアを一つのカラムに保存可能
- Materialized View
  - キャッシュされたView。高速化は期待できるが手動でRefreshする必要がある
- Stored Procedure (PL/pgSQL)
  - PostgreSQLで実行可能なfunctionを定義可能。
</pre>


<h2>その他勉強になったこと</h2>

<ul>
<li>データの分布 = 「統計情報」が大事</li>
<li>SerializeよりはJSONのほうがいいかも</li>
<li>PostgreSQL - indexの利用状況を閲覧できる - pg_stat_user_indexes</li>
<li>Gem <strong><a href="https://github.com/grosser/bitfields">grosser/bitfields</a></strong> 便利そう</li>
</ul>


<h2>まとめ</h2>

<pre>
- SQLの実行児に選ばれる実行計画は、indexの有無や統計情報(データの量・分布)に依存
- 適切なschema, index, queryの選択によって、高速化しよう
- WHERE, JOIN,ORDER BY, GROUP BYのkeyにはindex
- JOINの前に絞り込めるだけ絞り込む
- JSON Typeなどもケースバイケースで
</pre>


<h2>最後に</h2>

<p>懇親会で、ピザやビールを大量あってお腹いっぱいになれました。
めっちゃ有りがたかったです！</p>

<br style="clear:both;"/>


<p><div>
  <script type="text/javascript"><!--
  google_ad_client = "ca-pub-4186413323075068";
  /* middle_yoko_naga2 */
  google_ad_slot = "4362325392";
  google_ad_width = 728;
  google_ad_height = 90;
  //-->
  </script>
  <script type="text/javascript"
          src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
  </script>
</div></p>
]]></content>
  </entry>
  
</feed>
